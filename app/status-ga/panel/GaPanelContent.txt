// app/status-ga/panel/GaPanelContent.tsx
"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { useAuth } from "@/lib/auth-context";
import { NavbarStatic } from "@/components/navbar-static";
import { Sidebar } from "@/components/Sidebar";

interface PanelItem {
  no: number;
  namaPanel: string;
  area: string;
}

interface ChecksheetResult {
  _savedAt?: string;
  tempC: string;
  tempCableConnect: string;
  tempCable: string;
  bau: string;
  suara: string;
  sistemGrounding: string;
  kondisiKabelIsolasi: string;
  indikatorPanel: string;
  elcb: string;
  safetyWarning: string;
  kondisiSambunganR: string;
  kondisiSambunganS: string;
  kondisiSambunganT: string;
  boxPanel: string;
  s5: string;
  keteranganNg1: string;
}

export function GaPanelContent({ openPanel }: { openPanel: string }) {
  const router = useRouter();
  const { user, loading } = useAuth();
  const [isMounted, setIsMounted] = useState(false);
  const [showModal, setShowModal] = useState(false);

  useEffect(() => {
    setIsMounted(true);
  }, []);

  useEffect(() => {
    if (loading) return;
    if (!user || (user.role !== "group-leader" && user.role !== "inspector-ga")) {
      router.push("/login-page");
    }
  }, [user, loading, router]);

  useEffect(() => {
    if (!isMounted || loading) return;
    if (!openPanel) return;
    const found = panels.find((p) => p.namaPanel === openPanel);
    if (found) {
      setTimeout(() => openDetail(found), 50);
    }
  }, [isMounted, loading, openPanel]);

  const panels: PanelItem[] = [
    { no: 1, namaPanel: "MCC Sump 1", area: "Pintu 3 Genba A" },
    { no: 2, namaPanel: "MCC Sump 2", area: "Pintu 1 Genba A" },
    { no: 3, namaPanel: "MCC Sump 3", area: "Samping Meeting Room" },
    { no: 4, namaPanel: "MCC Sump 4", area: "Toilet Security" },
    { no: 5, namaPanel: "MCC Sump 5", area: "Toilet Wanita D" },
    { no: 6, namaPanel: "MCC Sump 6", area: "Pintu 9" },
    { no: 7, namaPanel: "MCC Sump 7", area: "Parkir Mobil" },
    { no: 8, namaPanel: "MCC Sump Main Office", area: "Polytainer Exim" },
    { no: 9, namaPanel: "sump new (auditorium)", area: "Submersible Pump Control Panel" },
    { no: 10, namaPanel: "LP OLP - 1", area: "Loading Dock Warehouse" },
    { no: 11, namaPanel: "LP OLP - 2", area: "Samping Masjid" },
    { no: 12, namaPanel: "LP Training", area: "Training Room" },
    { no: 13, namaPanel: "LP Kantin", area: "Kantin Room" },
    { no: 14, namaPanel: "PP Dep Well", area: "TPA" },
    { no: 15, namaPanel: "STP", area: "IPAL" },
    { no: 16, namaPanel: "PP Computer", area: "Main Office" },
    { no: 17, namaPanel: "PP/LP Office", area: "Main Office" },
    { no: 18, namaPanel: "LP GH", area: "Pos Security" },
    { no: 19, namaPanel: "Workshop", area: "Workshop" },
    { no: 20, namaPanel: "Segitiga", area: "Area Segitiga" },
  ];

  const [selectedPanel, setSelectedPanel] = useState<PanelItem | null>(null);
  const [checksheetData, setChecksheetData] = useState<ChecksheetResult[] | null>(null);
  const [savedDates, setSavedDates] = useState<Record<string, string>>({});

  const formatDate = (dateString: string): string => {
    if (!dateString) return "-";
    const d = new Date(dateString);
    if (isNaN(d.getTime())) return "-";
    return d.toLocaleDateString("id-ID");
  };

  const openDetail = (panel: PanelItem) => {
    setSelectedPanel(panel);
    const key = `e-checksheet-panel-${panel.namaPanel}`;
    const saved = typeof window !== "undefined" ? localStorage.getItem(key) : null;
    if (saved) {
      try {
        const data = JSON.parse(saved);
        if (Array.isArray(data)) {
          setChecksheetData(data);
        } else {
          setChecksheetData([data]);
        }
      } catch (e) {
        setChecksheetData(null);
      }
    } else {
      setChecksheetData(null);
    }
    setShowModal(true);
  };

  const closeDetail = () => {
    setSelectedPanel(null);
    setChecksheetData(null);
    setShowModal(false);
  };

  useEffect(() => {
    if (typeof window === "undefined") return;
    const map: Record<string, string> = {};
    panels.forEach((panel) => {
      try {
        const key = `e-checksheet-panel-${panel.namaPanel}`;
        const saved = localStorage.getItem(key);
        if (saved) {
          const data = JSON.parse(saved);
          map[panel.namaPanel] = formatDate(data?._savedAt || "");
        } else {
          map[panel.namaPanel] = "-";
        }
      } catch (e) {
        map[panel.namaPanel] = "-";
      }
    });
    setSavedDates(map);
  }, []);

  if (!isMounted) {
    return null;
  }

  if (loading) {
    return (
      <div style={{ display: "flex", justifyContent: "center", alignItems: "center", minHeight: "100vh", background: "#f5f5f5" }}>
        <p>Loading...</p>
      </div>
    );
  }

  if (!user || (user.role !== "inspector-ga" && user.role !== "group-leader")) {
    return null;
  }

  return (
    <div className="app-page">
      <Sidebar userName={user?.fullName} />
      <div className="page-content" style={{
        paddingLeft : "95px",
        paddingRight : "25px",
        paddingBottom : "32px",
        paddingTop : "32px",
      }}>
        <div className="header-section">
          <div className="header-content">
            <h1>GA Panel Inspection</h1>
            <p className="header-subtitle">Manajemen Data Inspeksi Kelayakan Panel Listrik</p>
          </div>
        </div>

        <div className="table-container">
          <table className="status-table">
            <thead>
              <tr>
                <th className="col-no">No</th>
                <th className="col-nama-panel">Nama Panel</th>
                <th className="col-area">Area</th>
                <th className="col-action">Aksi</th>
              </tr>
            </thead>
            <tbody>
              {panels.map((panel) => {
                const savedDate = savedDates[panel.namaPanel] || "-";

                return (
                  <tr key={panel.no}>
                    <td className="col-no">{panel.no}</td>
                    <td className="col-nama-panel">{panel.namaPanel}</td>
                    <td className="col-area">{panel.area}</td>
                    <td className="col-action">
                      <div className="action-cell">
                        <button onClick={() => openDetail(panel)} className="btn-detail">
                          DETAIL
                        </button>
                        <a
                          href={`/e-checksheet-panel?panelName=${encodeURIComponent(panel.namaPanel)}&area=${encodeURIComponent(panel.area)}&date=${new Date().toISOString().split("T")[0]}`}
                          className="btn-check"
                        >
                          CHECK
                        </a>
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>

        {isMounted && showModal && selectedPanel && (
          <div className="modal-overlay" onClick={closeDetail}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <div className="modal-title-section">
                  <h2>Detail Panel</h2>
                  <p className="modal-subtitle">{selectedPanel.namaPanel}</p>
                </div>
                <button onClick={closeDetail} className="btn-close">
                  ×
                </button>
              </div>

              <div className="modal-body">
                {!checksheetData || checksheetData.length === 0 ? (
                  <div className="empty-state">
                    <p>Belum ada data pengecekan</p>
                  </div>
                ) : (
                  <div className="detail-table-container">
                    {checksheetData.map((entry, idx) => (
                      <div key={idx} className="table-section">
                        <div className="table-section-header">
                          <h3>Pemeriksaan #{idx + 1}</h3>
                          <span className="table-section-date">{formatDate(entry._savedAt || "")}</span>
                        </div>
                        <table className="detail-table">
                          <tbody>
                            <tr>
                              <td className="label">Temp (°C)</td>
                              <td className="value">{entry.tempC || "-"}</td>
                              <td className="label">Temp Cable Connect</td>
                              <td className="value">{entry.tempCableConnect || "-"}</td>
                            </tr>
                            <tr>
                              <td className="label">Temp Cable</td>
                              <td className="value">{entry.tempCable || "-"}</td>
                              <td className="label">Bau</td>
                              <td className="value">{entry.bau || "-"}</td>
                            </tr>
                            <tr>
                              <td className="label">Suara</td>
                              <td className="value">{entry.suara || "-"}</td>
                              <td className="label">Grounding</td>
                              <td className="value">{entry.sistemGrounding || "-"}</td>
                            </tr>
                            <tr>
                              <td className="label">Kabel & Isolasi</td>
                              <td className="value">{entry.kondisiKabelIsolasi || "-"}</td>
                              <td className="label">Indikator Panel</td>
                              <td className="value">{entry.indikatorPanel || "-"}</td>
                            </tr>
                            <tr>
                              <td className="label">ELCB</td>
                              <td className="value">{entry.elcb || "-"}</td>
                              <td className="label">Safety Warning</td>
                              <td className="value">{entry.safetyWarning || "-"}</td>
                            </tr>
                            <tr>
                              <td className="label">Sambungan R</td>
                              <td className="value">{entry.kondisiSambunganR || "-"}</td>
                              <td className="label">Sambungan S</td>
                              <td className="value">{entry.kondisiSambunganS || "-"}</td>
                            </tr>
                            <tr>
                              <td className="label">Sambungan T</td>
                              <td className="value">{entry.kondisiSambunganT || "-"}</td>
                              <td className="label">Box Panel</td>
                              <td className="value">{entry.boxPanel || "-"}</td>
                            </tr>
                            <tr>
                              <td className="label">5S</td>
                              <td className="value">{entry.s5 || "-"}</td>
                              <td className="label">Keterangan</td>
                              <td className="value">{entry.keteranganNg1 || "-"}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              <div className="modal-footer">
                <button onClick={closeDetail} className="btn-cancel">
                  Tutup
                </button>
              </div>
            </div>
          </div>
        )}
      </div>

      <style jsx>{`
        .app-page {
          min-height: 100vh;
          background: #f8f9fa;
        }

        .page-content {
          padding: 32px 24px;
          max-width: 1400px;
          margin: 0 auto;
        }

        .header-section {
          margin-bottom: 32px;
        }

        .header-content {
          background: linear-gradient(135deg, #0d47a1 0%, #1e88e5 100%);
          border-radius: 12px;
          padding: 24px 32px;
          box-shadow: 0 4px 12px rgba(13, 71, 161, 0.15);
        }

        .header-content h1 {
          margin: 0 0 8px 0;
          color: white;
          font-size: 28px;
          font-weight: 700;
          letter-spacing: -0.5px;
        }

        .header-subtitle {
          margin: 0;
          color: rgba(255, 255, 255, 0.9);
          font-size: 14px;
          font-weight: 400;
        }

        .table-container {
          background: white;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
          overflow: hidden;
          border: 1px solid #e8e8e8;
        }

        .status-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 14px;
        }

        .status-table th,
        .status-table td {
          padding: 12px 16px;
          text-align: left;
          border-bottom: 1px solid #f0f0f0;
          vertical-align: middle;
        }

        .status-table th {
          background: #f5f7fa;
          font-weight: 600;
          color: #0d47a1;
          font-size: 13px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .status-table tbody tr {
          transition: background-color 0.2s ease;
        }

        .status-table tbody tr:hover {
          background-color: #fafbfc;
        }

        .col-tanggal {
          width: 110px;
          text-align: center;
          color: #666;
        }

        .col-no {
          width: 50px;
          text-align: center;
          font-weight: 600;
          color: #333;
        }

        .col-nama-panel {
          min-width: 200px;
          font-weight: 500;
          color: #1e88e5;
        }

        .col-area {
          min-width: 180px;
          color: #666;
          font-size: 13px;
        }

        .col-action {
          width: 220px;
        }

        .action-cell {
          display: flex;
          gap: 8px;
        }

        .btn-detail,
        .btn-check {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: 6px 14px;
          border-radius: 6px;
          font-size: 12px;
          font-weight: 600;
          text-decoration: none;
          cursor: pointer;
          border: none;
          transition: all 0.3s ease;
          white-space: nowrap;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .btn-detail {
          background: #1e88e5;
          color: white;
        }

        .btn-detail:hover {
          background: #0d47a1;
          box-shadow: 0 2px 8px rgba(13, 71, 161, 0.3);
          transform: translateY(-1px);
        }

        .btn-check {
          background: #4caf50;
          color: white;
        }

        .btn-check:hover {
          background: #388e3c;
          box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
          transform: translateY(-1px);
        }

        .modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          padding: 20px;
        }

        .modal-content {
          background: white;
          border-radius: 12px;
          width: 95%;
          max-width: 1000px;
          max-height: 90vh;
          overflow-y: auto;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          display: flex;
          flex-direction: column;
        }

        .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          padding: 24px 28px;
          background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
          border-bottom: 2px solid #e8e8e8;
          flex-shrink: 0;
        }

        .modal-title-section h2 {
          margin: 0 0 4px 0;
          color: #0d47a1;
          font-size: 20px;
          font-weight: 700;
        }

        .modal-subtitle {
          margin: 0;
          color: #1e88e5;
          font-size: 14px;
          font-weight: 500;
        }

        .btn-close {
          background: none;
          border: none;
          font-size: 28px;
          cursor: pointer;
          color: #999;
          padding: 0;
          width: 32px;
          height: 32px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.3s ease;
          flex-shrink: 0;
        }

        .btn-close:hover {
          color: #d32f2f;
          background: rgba(211, 47, 47, 0.1);
          border-radius: 6px;
        }

        .modal-body {
          padding: 28px;
          overflow-y: auto;
          flex: 1;
        }

        .detail-table-container {
          display: flex;
          flex-direction: column;
          gap: 20px;
        }

        .table-section {
          background: white;
          border: 1px solid #e8e8e8;
          border-radius: 10px;
          overflow: hidden;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .table-section-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 16px 20px;
          background: #f5f9ff;
          border-bottom: 1px solid #e8e8e8;
        }

        .table-section-header h3 {
          margin: 0;
          color: #0d47a1;
          font-size: 16px;
          font-weight: 600;
        }

        .table-section-date {
          color: #666;
          font-size: 13px;
          font-weight: 500;
        }

        .detail-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 14px;
        }

        .detail-table tbody tr {
          border-bottom: 1px solid #f0f0f0;
          transition: background-color 0.2s ease;
        }

        .detail-table tbody tr:hover {
          background-color: #fafbfc;
        }

        .detail-table td {
          padding: 12px 16px;
          vertical-align: middle;
        }

        .detail-table td.label {
          font-weight: 600;
          color: #1e88e5;
          font-size: 12px;
          text-transform: uppercase;
          letter-spacing: 0.3px;
          width: 25%;
          background: #f9fbfd;
        }

        .detail-table td.value {
          color: #333;
          font-weight: 500;
          width: 25%;
          word-break: break-word;
        }

        .empty-state {
          text-align: center;
          padding: 40px 20px;
          color: #999;
          font-size: 14px;
        }

        .modal-footer {
          display: flex;
          justify-content: flex-end;
          padding: 20px 28px;
          background: #f5f7fa;
          border-top: 1px solid #e8e8e8;
          gap: 12px;
          flex-shrink: 0;
        }

        .btn-cancel {
          padding: 8px 20px;
          background: #bdbdbd;
          color: white;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-size: 13px;
          font-weight: 600;
          transition: all 0.3s ease;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .btn-cancel:hover {
          background: #757575;
          transform: translateY(-1px);
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        @media (max-width: 768px) {
          .page-content {
            padding: 16px 12px;
          }

          .header-content {
            padding: 16px 20px;
          }

          .header-content h1 {
            font-size: 22px;
          }

          .action-cell {
            flex-direction: column;
          }

          .btn-detail,
          .btn-check {
            width: 100%;
          }

          .modal-content {
            max-width: 98%;
            max-height: 95vh;
          }
        }
      `}</style>
    </div>
  );
}